<html>
<head>
<style>
body {
	background-color: gray;
	font-family: sans-serif;
}

h1, h3 {
	color: #57ff00;
	text-align: center;
}

.tab-bar {
	display: flex;
	justify-content: center;
	margin-bottom: 1rem;
}

.tab-button {
	padding: 0.5rem 1rem;
	background-color: black;
	color: #57ff00;
	border: 1px solid #57ff00;
	cursor: pointer;
	margin: 0 0.2rem;
}

.tab-button.active {
	background-color: #57ff00;
	color: black;
}

.container {
	display: grid;
	grid-template-columns: 1fr 2fr;
	gap: 1rem;
	padding: 1.5rem;
	flex: 1;
}
@media (max-width: 768px) {
	.container {display: flex; flex-direction: column; padding: 1rem;}
}
.segment {
	background: black;
	border-radius: 8px;
	box-shadow: 0 1px 3px rgba(0,0,0,0.08);
	padding: 1.25rem;
	display: flex;
	flex-direction: column;
}

.segment table {
	color: #57ff00;
	width: 95%;
}

th {
	background-color: black;
}

tbody tr:nth-child(odd) {
	background: #4d4d4d;
}

tbody tr:nth-child(even) {
	background: #3d3d3d;
}

tbody tr:hover {background: #a1a1a1;}

tbody td {
	padding: 1rem 1rem;
}

input[type=number] {
	max-width: 75px;
}

input {
	min-height: 3rem;
	min-width: 1rem;
}

button {
	min-height: 2.5rem;
	background-color: white;
	border-radius: 4px;
	border: none;
}

button:hover {
	filter: brightness(85%);
}

.remove {
	min-width: 40px;
}

.input-block {
	width: 100%;
	color: #57ff00;
	margin-bottom: 1rem;
	margin-top: 1rem;
}

.input-block * {
	margin-left: 1rem;
}

.message {
	margin: 1rem 1rem 1rem 1rem;
	color: #f2ee0f;
}

    .history-list {
    color: white;
    list-style: none;
    padding: 0;
    margin-top: 1rem;
}

.history-item {
    background: #2d2d2d;
    margin-bottom: 0.5rem;
    padding: 0.75rem;
    border-radius: 4px;
    border-left: 4px solid #57ff00;
    font-size: 0.9rem;
}

.sticky-action {
    background: black;
    padding: 10px;
    border-bottom: 1px solid #57ff00;
    margin-bottom: 1rem;
    display: flex;
    justify-content: center;
}

/* Mobile adjustments for 2026 standards */
@media (max-width: 768px) {
    .container { 
        display: flex; 
        flex-direction: column; 
    }
    button {
        width: 100%; /* Larger tap targets for mobile */
        margin-bottom: 10px;
    }
}

	.stat-card {
    background: #1a1a1a;
    border: 1px solid #57ff00;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 8px;
}
.stat-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}
.stat-btn {
    flex: 1;
    min-width: 60px;
    background: #333;
    color: #57ff00;
    border: 1px solid #57ff00;
    font-weight: bold;
}
.stat-avg {
    font-size: 1.5rem;
    color: #f2ee0f;
    float: right;
}

</style>
</head>
<body>
<h1>Fusion Work Assignment Generator</h1>

<div class="tab-bar">
    <button class="tab-button active" onclick="switchTab('workTab', this)">Work Assignments</button>
    <button class="tab-button" onclick="switchTab('captainTab', this)">Captain Picker</button>
    <button class="tab-button" onclick="switchTab('statTab', this)">Stat Tracker</button>
</div>

<div id="workTab" class="tab-content">
	<div class="container">
		<div class="segment">
			<div class="input-block">
				<button onclick="saveLineup()">Save Lineup</button>
				<button onclick="loadLineup()"> Load Lineup</button>
			</div>
			<h3>Roster</h3>
			<div id="roster-message" class="message"></div>
			<table id="roster">
				<thead>
					<th><input type="checkbox" onchange="rosterSelectAll()" id="roster-select-all" checked></th><th>#</th><th>Name</th><th></th>
				</thead>
				<tbody id="roster-body">
				</tbody>
				<tr style="height: 3rem;">
					<th><button onclick="addPlayer()" id="roster-add">Add</button></th>
					<th><input id="roster-number" type="number"></th>
					<th><input id="roster-name" type="text"></th>
					<th></th>
				</tr>
			</table>
			<div class="input-block"><label for="settings-num-games"># of sets to work: </label><input id="settings-num-games" type="number" step="1" value="3"></div>
			<div class="input-block"><label for="settings-starter">Start with worker: </label><input id="settings-starter" type="text" placeholder="name or # (optional)"></div>
			<div class="input-block"><button onclick="generateAssignments()">Generate Work Assignments</button></div>
		</div>
		<div class="segment">
			<div class="message" id="message"></div>
			<table id="assignments">
				<thead>
					<th><input class="job" type="checkbox" id="assignments-l1" checked>Lines 1</th>
					<th><input class="job" type="checkbox" id="assignments-book" checked>Bookkeeper</th>
					<th><input class="job" type="checkbox" id="assignments-score" checked>Scorekeeper</th>
					<th><input class="job" type="checkbox" id="assignments-l2" checked>Lines 2</th>
					<th><input class="job" type="checkbox" id="assignments-down" checked>Down Ref</th>
					<th><input class="job" type="checkbox" id="assignments-lib" checked>Libero Tracker</th>
				</thead>
				<tbody id="assignments-body">
				</tbody>
			</table>
		</div>
	</div>
</div>

<div id="captainTab" class="tab-content" style="display: none;">
    <!-- Sticky Quick-Action for Mobile -->
    <div class="sticky-action">
        <button onclick="pickCaptains()" style="background-color: #57ff00; color: black; font-weight: bold; padding: 0 2rem;">
            PICK CAPTAINS NOW
        </button>
    </div>

    <div class="container">
        <div class="segment">
            <div class="input-block">
                <button onclick="saveLineup()">Save Lineup</button>
                <button onclick="loadLineup()"> Load Lineup</button>
            </div>
            <h3>Available Players</h3>
            <div id="captain-message" class="message"></div>
            <table id="captain-roster">
                <thead>
                    <th><input type="checkbox" onchange="captainSelectAll()" id="captain-select-all" checked></th><th>#</th><th>Name</th>
                </thead>
                <tbody id="captain-roster-body"></tbody>
            </table>
            <div class="input-block">
                <button onclick="resetCaptainPool()">Reset Pool & History</button>
            </div>
        </div>
        
        <div class="segment">
            <h3>History</h3>
            <div id="captains-output" class="message" style="color: #57ff00; font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 10px;">
                No captains selected yet.
            </div>
            <ul id="captain-history" class="history-list">
                <!-- History items will appear here -->
            </ul>
        </div>
    </div>
</div>

<div id="statTab" class="tab-content" style="display: none;">
    <div class="container">
        <div class="segment">
            <h3>Add New Stat Category</h3>
            <div class="input-block">
                <label>Skill Name:</label>
                <input id="new-stat-name" type="text" placeholder="e.g. Passing">
            </div>
            <div class="input-block">
                <label>Max Value (0-X):</label>
                <input id="new-stat-max" type="number" value="3" min="1">
            </div>
            <div class="input-block">
                <button onclick="addStatCategory()" style="background: #57ff00; color: black;">Create Stat Buttons</button>
            </div>
        </div>
        
        <div class="segment" id="active-stats-container">
            <h3>Team Stats</h3>
            <!-- Dynamic stats appear here -->
        </div>
    </div>
</div>

<script>

ROSTER = [];
// A separate pool for the captain picker to manage availability and resets
CAPTAIN_POOL = []; 

// --- Stat Tracker Logic ---
let TEAM_STATS = {};

function addStatCategory() {
    const name = document.getElementById('new-stat-name').value.trim();
    const maxValue = parseInt(document.getElementById('new-stat-max').value);
    
    if (!name) return;

    TEAM_STATS[name] = {
        totalPoints: 0,
        count: 0,
        maxValue: maxValue
    };

    document.getElementById('new-stat-name').value = '';
    renderStats();
}

function recordStat(skillName, value) {
    TEAM_STATS[skillName].totalPoints += value;
    TEAM_STATS[skillName].count += 1;
    renderStats();
}

function renderStats() {
    const container = document.getElementById('active-stats-container');
    // Clear but keep the header
    container.innerHTML = '<h3>Team Stats</h3>';

    for (let skill in TEAM_STATS) {
        const data = TEAM_STATS[skill];
        const avg = data.count > 0 ? (data.totalPoints / data.count).toFixed(2) : "0.00";
        
        let card = document.createElement('div');
        card.className = 'stat-card';
        
        let html = `
            <span class="stat-avg">Avg: ${avg}</span>
            <strong style="color: #57ff00; font-size: 1.2rem;">${skill}</strong>
            <div style="color: #888; font-size: 0.8rem;">Attempts: ${data.count} | Total: ${data.totalPoints}</div>
            <div class="stat-grid">
        `;

        for (let i = 0; i <= data.maxValue; i++) {
            html += `<button class="stat-btn" onclick="recordStat('${skill}', ${i})">${i}</button>`;
        }

        html += `</div>`;
        card.innerHTML = html;
        container.appendChild(card);
    }
}

// Ensure the new tab is handled in your switchTab function
function switchTab(tabId, buttonElement) {
    const contents = document.getElementsByClassName('tab-content');
    for (let i = 0; i < contents.length; i++) contents[i].style.display = 'none';
    
    const buttons = document.getElementsByClassName('tab-button');
    for (let i = 0; i < buttons.length; i++) buttons[i].classList.remove('active');

    document.getElementById(tabId).style.display = 'block';
    buttonElement.classList.add('active');
}


// --- Generic Roster Management Functions (Used by both tabs) ---

function saveLineup() {
	localStorage.setItem('roster', JSON.stringify(ROSTER));
	document.getElementById('roster-message').innerHTML = `Lineup has been saved.`;
    if(document.getElementById('captain-message')) document.getElementById('captain-message').innerHTML = `Lineup has been saved.`;
}

function loadLineup() {
	ROSTER = JSON.parse(localStorage.getItem('roster'));
	document.getElementById('roster-message').innerHTML = `Lineup has been loaded.`;
    if(document.getElementById('captain-message')) document.getElementById('captain-message').innerHTML = `Lineup has been loaded.`;
    refreshRoster();
    refreshCaptainRoster(); // Also load for the captain picker
}

function addPlayer() {
	let p = {};
	p.number = document.getElementById('roster-number').value;
	p.name = document.getElementById('roster-name').value;
	ROSTER.push(p);
	document.getElementById('roster-number').value = '';
	document.getElementById('roster-name').value = '';
	refreshRster();
    refreshCaptainRoster(); // Update captain roster too
}

function removePlayer(index) {
	if(confirm(`Remove ${ROSTER[index].name} (${ROSTER[index].number}) from roster?`) == true) {
		ROSTER.splice(index, 1);
		refreshRoster();
        refreshCaptainRoster(); // Update captain roster too
	}
}


// --- Work Assignment Tab Functions ---

function rosterSelectAll() {
	const sel = document.getElementById('roster-select-all').checked;
	for(let i = 0; i < ROSTER.length; i++) {
		document.getElementById(`roster-cb-${i}`).checked = sel;
	}
}

function rosterSelect(index) {
	if(!document.getElementById(`roster-cb-${index}`).checked) {
		document.getElementById(`roster-select-all`).checked = false;
	}
}

function refreshRoster() {
	let html = '';
	for(let i = 0; i < ROSTER.length; i++) {
		html += `<tr><td><input onchange="rosterSelect(${i})" id="roster-cb-${i}" type="checkbox" checked></td><td>${ROSTER[i].number}</td><td>${ROSTER[i].name}</td><td><button class="remove" onclick="removePlayer(${i})" id="roster-remove-#{i}"> - </button></td></tr>`;
	}
	document.getElementById('roster-body').innerHTML = html;
}

function generateAssignments() {
	let start = document.getElementById('settings-starter').value;
	const numOfGames = document.getElementById('settings-num-games').value;
	let first = -1;
	//calculate active jobs
	const allJobs = document.getElementsByClassName("job");
	let activeJobs = [];
	let startingJob = 0;
	for(let i = 0; i < allJobs.length; i++) {
		if(allJobs[i].checked) {
			activeJobs.push(allJobs[i]);
		}
	}
	//calculate active roster
	let activeRoster = [];
	for(let i = 0; i < ROSTER.length; i++) {
		if(document.getElementById(`roster-cb-${i}`).checked) {
			activeRoster.push(ROSTER[i]);
		}
	}
	//check if enough workers
	if(activeRoster.length < activeJobs.length) {
		document.getElementById('message').innerHTML = 'Not enough active workers.';
		return;
	}
	
	if(start !== '') {
		if(isNaN(start)) {
			for(let i = 0; i < activeRoster.length; i++) {
				if(activeRoster[i].name === start) {
					first = i;
					break;
				}
				if(first === -1 && activeRoster[i].indexOf(start) !== -1) {
					first = i;
				}
			}
		} else {
			start = parseInt(start);
			for(let i = 0; i < activeRoster.length; i++) {
				if(parseInt(activeRoster[i].number) === start) {
					first = i;
					break;
				}
			}
		}
	}
	if(first === -1)
		first = 0;
	
	let assignments = [];
	
	for(let i = 0; i < numOfGames; i++) {
		let a = {};
		let workers = [];
		console.log(first);
		while(workers.length < activeJobs.length) {
			workers.push(activeRoster[first]);
			first++;
			if(first >= activeRoster.length)
				first = 0;
		}		
		
		console.log("workers ");
		console.log(workers);
		//if(activeRoster.length % activeJobs.length === 0) {
			for(let j = 0; j < i; j++) {
				workers.push(workers.shift());
			}
		//}
		for(let j = 0; j < activeJobs.length; j++) {
			a[activeJobs[j].id] = workers[j];
		}
		assignments.push(a);
	}
	console.log(assignments);
	let html = ``;
	
	for(let i = 0; i < assignments.length; i++) {
		html += `<tr>`;
		for(let j = 0; j < allJobs.length; j++) {
			if(!assignments[i].hasOwnProperty(allJobs[j].id)) {
				html += `<td></td>`;
			} else {
				const player = assignments[i][allJobs[j].id];
				html += `<td>${player.name} (${player.number})</td>`;
			}
		}
		html += `</tr>`;
	}
	document.getElementById('assignments-body').innerHTML = html;
}


// --- Captain Picker Tab Functions ---

function captainSelectAll() {
    const sel = document.getElementById('captain-select-all').checked;
    // We update the ROSTER array's "available" status here
    for(let i = 0; i < ROSTER.length; i++) {
        ROSTER[i].available = sel;
    }
    refreshCaptainRoster();
}

function captainSelect(index) {
    // Update the ROSTER array's "available" status when a checkbox is clicked
    ROSTER[index].available = document.getElementById(`captain-cb-${index}`).checked;

    if(!ROSTER[index].available) {
        document.getElementById(`captain-select-all`).checked = false;
    }
}

function refreshCaptainRoster() {
    let html = '';
    for(let i = 0; i < ROSTER.length; i++) {
        // Ensure "available" property exists for new players added
        if (typeof ROSTER[i].available === 'undefined') {
            ROSTER[i].available = true; // Default to available
        }
        const checkedStatus = ROSTER[i].available ? 'checked' : '';
        html += `<tr><td><input onchange="captainSelect(${i})" id="captain-cb-${i}" type="checkbox" ${checkedStatus}></td><td>${ROSTER[i].number}</td><td>${ROSTER[i].name}</td></tr>`;
    }
    document.getElementById('captain-roster-body').innerHTML = html;
}

function resetCaptainPool() {
    for (let i = 0; i < ROSTER.length; i++) {
        ROSTER[i].available = true;
    }
    CAPTAIN_HISTORY = []; // Clear history on reset
    document.getElementById('captain-history').innerHTML = '';
    document.getElementById('captain-select-all').checked = true;
    document.getElementById('captains-output').innerHTML = 'Pool and history reset.';
    refreshCaptainRoster();
}

function pickCaptains() {
    // Get all currently available players from the ROSTER array
    const availablePlayers = ROSTER.filter(player => player.available);

    if (availablePlayers.length < 2) {
        document.getElementById('captains-output').innerHTML = 'Not enough players available to pick 2 captains. Reset the pool or add more players.';
        return;
    }

    // Pick 2 random players
    const index1 = Math.floor(Math.random() * availablePlayers.length);
    const captain1 = availablePlayers[index1];

    // Remove the first captain from the temp list for the second pick
    availablePlayers.splice(index1, 1);

    const index2 = Math.floor(Math.random() * availablePlayers.length);
    const captain2 = availablePlayers[index2];

    // Display selected captains
    document.getElementById('captains-output').innerHTML = `
        Captain 1: ${captain1.name} (${captain1.number})<br>
        Captain 2: ${captain2.name} (${captain2.number})
    `;

    // Remove selected captains from the main ROSTER's available pool so they can't be picked again this session
    // Find the original indices in the ROSTER and set their 'available' status to false
    const originalIndex1 = ROSTER.findIndex(p => p.number === captain1.number && p.name === captain1.name);
    const originalIndex2 = ROSTER.findIndex(p => p.number === captain2.number && p.name === captain2.name);
    
    if (originalIndex1 !== -1) ROSTER[originalIndex1].available = false;
    if (originalIndex2 !== -1) ROSTER[originalIndex2].available = false;

    // Refresh the UI to reflect who is still available
    refreshCaptainRoster();
}


function updateHistoryUI() {
    let html = '';
    CAPTAIN_HISTORY.forEach((entry, index) => {
        html += `<li class="history-item"><strong>Round ${CAPTAIN_HISTORY.length - index}:</strong> ${entry}</li>`;
    });
    document.getElementById('captain-history').innerHTML = html;
}
// Initialize on load
document.addEventListener('DOMContentLoaded', (event) => {
    // Try to load lineup automatically if saved
    if (localStorage.getItem('roster')) {
        loadLineup();
    } else {
        refreshRoster();
        refreshCaptainRoster();
    }
});

</script>
</body>
</html>


