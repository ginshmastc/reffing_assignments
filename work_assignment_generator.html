<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VB Manager 2026</title>
    <style>
        :root {
            --bg-dark: #121212;
            --panel-bg: #1e1e1e;
            --neon-green: #39FF14;
            --text-color: #e0e0e0;
            --danger: #ff4d4d;
            --border: #333;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0; background: var(--bg-dark); color: var(--text-color);
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* 2026 Mobile Navigation */
        nav {
            background: #000; display: flex; padding: 10px; gap: 8px;
            border-bottom: 1px solid var(--border); z-index: 100;
        }

        .tab-btn {
            flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border);
            background: #222; color: #888; font-weight: bold; font-size: 14px; cursor: pointer;
        }

        .tab-btn.active { background: var(--neon-green); color: #000; border-color: var(--neon-green); }

        main { display: flex; flex: 1; flex-direction: column; overflow: hidden; }

        /* ROSTER SECTION: Optimized to stay small on mobile */
        #roster-section {
            height: 30vh; min-height: 200px;
            background: var(--panel-bg); border-bottom: 2px solid var(--border);
            display: flex; flex-direction: column;
        }

        .roster-header { padding: 10px 15px; background: #000; font-size: 14px; font-weight: bold; color: var(--neon-green); }
        #rosterBody { flex: 1; overflow-y: auto; padding: 10px; }

        .player-row {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            background: #282828; border-radius: 8px; margin-bottom: 5px; border: 1px solid #333;
        }
        .player-row input[type="text"] { flex: 1; min-width: 0; font-size: 16px; } /* 16px prevents iOS zoom */
        .player-row input[type="number"] { width: 50px; }

        .controls { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #000; }

        /* TOOLS SECTION: Given priority space */
        #tool-content { flex: 2; overflow-y: auto; padding: 15px; background: var(--bg-dark); }
        .tool-panel { display: none; }
        .tool-panel.active { display: block; }

        .job-pool-config {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            background: #000; padding: 15px; border-radius: 12px; margin-bottom: 15px;
        }

        /* Desktop Layout (Wider Screens) */
        @media (min-width: 800px) {
            main { flex-direction: row; }
            #roster-section { width: 320px; height: 100%; border-right: 2px solid var(--border); border-bottom: none; }
            #tool-content { flex: 1; }
        }

        /* Assignment Table Mobile Fix */
        .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; }
        .assignment-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .assignment-table th { background: var(--neon-green); color: #000; padding: 12px; position: sticky; top: 0; }
        .assignment-table td { padding: 12px; border-bottom: 1px solid var(--border); text-align: center; background: #1a1a1a; }

        input, button { background: #000; border: 1px solid #444; color: #fff; border-radius: 6px; padding: 8px; }
        .btn-main { background: var(--neon-green); color: #000; font-weight: bold; width: 100%; padding: 15px; margin-top: 10px; border-radius: 10px; }
        .btn-del { background: var(--danger); font-size: 12px; padding: 5px 10px; }
    </style>
</head>
<body>

<nav>
    <button class="tab-btn active" onclick="showTool('work-tool', this)">Assignments</button>
    <button class="tab-btn" onclick="showTool('captain-tool', this)">Captains</button>
</nav>

<main>
    <section id="roster-section">
        <div class="roster-header">Team Roster</div>
        <div id="rosterBody"></div>
        <div class="controls">
            <button onclick="addPlayer()">+ Add</button>
            <button onclick="sortRoster()">Sort</button>
            <button class="tab-btn active" style="grid-column: span 2" onclick="saveRoster()">SAVE ROSTER</button>
        </div>
    </section>

    <section id="tool-content">
        <div id="work-tool" class="tool-panel active">
            <div style="text-align: center; margin-bottom: 15px;">
                <button class="btn-del" onclick="resetShiftCounter()" style="width: 100%; height: 50px; font-weight: bold;">
                    RESET REFFED COUNT: <span id="counterVal">0</span>
                </button>
            </div>

            <div class="job-pool-config">
                <label><input type="checkbox" class="job-check" value="Lines 1" checked> Lines 1</label>
                <label><input type="checkbox" class="job-check" value="Book" checked> Book</label>
                <label><input type="checkbox" class="job-check" value="Score" checked> Score</label>
                <label><input type="checkbox" class="job-check" value="Lines 2" checked> Lines 2</label>
                <label><input type="checkbox" class="job-check" value="Down Ref" checked> Down Ref</label>
                <label><input type="checkbox" class="job-check" value="Libero" checked> Libero</label>
            </div>

            <div style="display: flex; gap: 10px;">
                <input type="number" id="sets" value="3" style="width: 70px;" placeholder="Sets">
                <button class="btn-main" style="margin-top:0" onclick="generate()">GENERATE ASSIGNMENTS</button>
            </div>

            <div class="table-wrapper" style="margin-top: 20px;">
                <div id="assignTable"></div>
            </div>
        </div>

<!-- Updated Captain Picker UI -->
<div id="captain-tool" class="tool-panel">
    <button class="btn-main" onclick="pickPair()">[ PICK NEW PAIR ]</button>
    
    <div style="display: flex; gap: 10px; margin: 20px 0;">
        <div class="captain-card-container">
            <div id="cap1" class="captain-card-mobile">?</div>
            <button class="btn-reroll" onclick="reroll(1)">Reroll 1</button>
        </div>
        <div class="captain-card-container">
            <div id="cap2" class="captain-card-mobile">?</div>
            <button class="btn-reroll" onclick="reroll(2)">Reroll 2</button>
        </div>
    </div>

    <div class="pool-section">
        <div class="pool-header">REMAINING POOL (<span id="poolCount">0</span>)</div>
        <div id="poolList" class="pool-chips-container"></div>
    </div>
</div>

<style>
    /* 2026 Neon Flare Animation */
    @keyframes flare {
        0% { box-shadow: 0 0 0 var(--neon-green); transform: scale(1); }
        50% { box-shadow: 0 0 25px var(--neon-green); transform: scale(1.05); background: var(--neon-green); color: #000; }
        100% { box-shadow: 0 0 5px var(--neon-green); transform: scale(1); }
    }
    .flare-active { animation: flare 0.6s ease-out; }

    .captain-card-container { flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .captain-card-mobile { 
        background: #000; border: 2px solid var(--neon-green); 
        padding: 25px 10px; text-align: center; border-radius: 12px; 
        font-weight: bold; font-size: 1.1em; min-height: 50px;
        transition: all 0.3s;
    }
    
    /* Pool Styles */
    .pool-section { margin-top: 20px; background: #000; padding: 15px; border-radius: 12px; }
    .pool-header { font-size: 12px; color: #888; margin-bottom: 10px; letter-spacing: 1px; }
    .pool-chips-container { 
        display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;
        scrollbar-width: none; /* Hide scrollbar for clean look */
    }
    .pool-chip { 
        background: #222; border: 1px solid #444; padding: 5px 12px; 
        border-radius: 20px; font-size: 12px; white-space: nowrap; color: #ccc;
    }
    .btn-reroll { background: #333; color: #aaa; border: 1px solid #444; padding: 8px; border-radius: 8px; font-size: 11px; font-weight: bold; }
</style>

    </section>
</main>

<script>
    // ... [Previous JavaScript Logic Stays the Same] ...
    let roster = JSON.parse(localStorage.getItem('vb-roster')) || [
        { name: "Player 1", number: "1", active: true },
        { name: "Player 2", number: "2", active: true },
        { name: "Player 3", number: "3", active: true },
        { name: "Player 4", number: "4", active: true }
    ];
    let globalPointer = parseInt(localStorage.getItem('vb-pointer')) || 0;
    let shiftCounter = parseInt(localStorage.getItem('vb-shift-counter')) || 0;

    function saveState() {
        localStorage.setItem('vb-pointer', globalPointer);
        localStorage.setItem('vb-shift-counter', shiftCounter);
        document.getElementById('counterVal').innerText = shiftCounter;
    }

    function render() {
        const body = document.getElementById('rosterBody');
        body.innerHTML = '';
        roster.forEach((p, i) => {
            body.innerHTML += `
                <div class="player-row">
                    <input type="checkbox" ${p.active ? 'checked' : ''} onchange="togglePlayer(${i})">
                    <input type="text" value="${p.name}" onchange="updateName(${i}, this.value)" placeholder="Name">
                    <input type="number" value="${p.number}" onchange="updateNum(${i}, this.value)" placeholder="#">
                    <button class="btn-del" onclick="removePlayer(${i})">Ã—</button>
                </div>`;
        });
        document.getElementById('counterVal').innerText = shiftCounter;
    }

    // Logic for 13-player rotation as verified previously
    function generate() {
        const active = roster.filter(p => p.active);
        const jobs = Array.from(document.querySelectorAll('.job-check:checked')).map(c => c.value);
        const numSets = parseInt(document.getElementById('sets').value);
        if (!active.length || !jobs.length) return;

        let html = `<table class="assignment-table"><thead><tr><th>Set</th>`;
        jobs.forEach(j => html += `<th>${j}</th>`);
        html += `</tr></thead><tbody>`;

        let currentPointer = globalPointer;
        for (let s = 0; s < numSets; s++) {
            html += `<tr><td>${s + 1}</td>`;
            let offset = (shiftCounter * 11 + s) % jobs.length;
            let assignments = new Array(jobs.length);
            for (let j = 0; j < jobs.length; j++) {
                let pIdx = (currentPointer + j) % active.length;
                assignments[(j + offset) % jobs.length] = active[pIdx].name;
            }
            assignments.forEach(n => html += `<td>${n}</td>`);
            html += `</tr>`;
            for(let i=0; i<jobs.length; i++) {
                currentPointer++;
                if(currentPointer >= active.length) { currentPointer = 0; shiftCounter++; }
            }
        }
        globalPointer = currentPointer; saveState();
        document.getElementById('assignTable').innerHTML = html + `</tbody></table>`;
    }

    function resetShiftCounter() { if(confirm("Reset all counts?")) { shiftCounter=0; globalPointer=0; saveState(); render(); } }
    function showTool(id, btn) {
        document.querySelectorAll('.tool-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active'); btn.classList.add('active');
    }
    function togglePlayer(i) { roster[i].active = !roster[i].active; }
    function updateName(i, v) { roster[i].name = v; }
    function updateNum(i, v) { roster[i].number = v; }
    function addPlayer() { roster.push({name:"", number:"", active:true}); render(); }
    function removePlayer(i) { roster.splice(i, 1); render(); }
    function sortRoster() { roster.sort((a,b) => a.number - b.number); render(); }
    function saveRoster() { localStorage.setItem('vb-roster', JSON.stringify(roster)); alert("Saved!"); }
    function pick() {
        const active = roster.filter(p => p.active);
        if (active.length < 2) return;
        const shuffled = [...active].sort(() => 0.5 - Math.random());
        document.getElementById('cap1').innerText = shuffled[0].name;
        document.getElementById('cap2').innerText = shuffled[1].name;
    }
	// Initialize pool from storage or empty
let captainPool = JSON.parse(localStorage.getItem('vb-captain-pool')) || [];
let currentCaptains = JSON.parse(localStorage.getItem('vb-current-caps')) || [null, null];

/** 
 * Logic Fix: Refreshes pool ONLY from active roster players 
 * who are NOT currently acting as captains.
 */
function refreshCaptainPool() {
    const activeRoster = roster.filter(p => p.active);
    const capIds = currentCaptains.filter(c => c).map(c => c.number);
    
    // Fill pool with players NOT in a captain slot
    captainPool = activeRoster.filter(p => !capIds.includes(p.number)).map(p => ({...p}));
    localStorage.setItem('vb-captain-pool', JSON.stringify(captainPool));
}

function pickPair() {
    // Complete reset of pair
    currentCaptains = [null, null];
    reroll(1);
    reroll(2);
}

/** 
 * Logic Fix: Rerolling a captain removes them from the game's current 
 * "available" list without putting them back into the pool.
 */
function reroll(slotIndex) {
    const activeRoster = roster.filter(p => p.active);
    if (activeRoster.length < 2) return alert("Min 2 active players required.");

    // 1. Logic Fix: Check pool exhaustion BEFORE picking. 
    // If pool is empty, refresh it from the roster (minus the current OTHER captain)
    if (captainPool.length === 0) {
        refreshCaptainPool();
    }

    // 2. Logic Fix: Select the new captain.
    // Use splice to permanently remove them from the pool for this rotation.
    const randIdx = Math.floor(Math.random() * captainPool.length);
    currentCaptains[slotIndex - 1] = captainPool.splice(randIdx, 1)[0];

    // 3. Persistent Save
    localStorage.setItem('vb-captain-pool', JSON.stringify(captainPool));
    localStorage.setItem('vb-current-caps', JSON.stringify(currentCaptains));
    
    // 4. Flair & UI Update
    const el = document.getElementById(`cap${slotIndex}`);
    if (el) {
        el.classList.remove('flare-active');
        void el.offsetWidth; // Trigger reflow for animation
        el.classList.add('flare-active');
    }

    updatePoolUI();
}

function updatePoolUI() {
    const poolCountEl = document.getElementById('poolCount');
    const poolListEl = document.getElementById('poolList');
    
    if (poolCountEl) poolCountEl.innerText = captainPool.length;
    
    if (poolListEl) {
        poolListEl.innerHTML = '';
        captainPool.forEach(p => {
            poolListEl.innerHTML += `<div class="pool-chip">#${p.number} ${p.name}</div>`;
        });
    }

    [1, 2].forEach(i => {
        const cap = currentCaptains[i-1];
        const box = document.getElementById(`cap${i}`);
        if (box) box.innerText = cap ? `${cap.name}\n#${cap.number}` : "?";
    });
}

// Ensure UI is ready on load
updatePoolUI();


    render();
</script>
</body>
</html>
