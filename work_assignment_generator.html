<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VB Manager 2026</title>
    <style>
        :root {
            --bg-dark: #121212; --panel-bg: #1e1e1e;
            --neon-green: #39FF14; --text-color: #e0e0e0;
            --danger: #ff4d4d; --border: #333;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0; background: var(--bg-dark); color: var(--text-color);
            display: flex; flex-direction: column; height: 100dvh; overflow: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* NAVIGATION */
        nav { background: #000; display: flex; padding: 10px; gap: 8px; border-bottom: 1px solid var(--border); z-index: 100; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #222; color: #888; font-weight: bold; cursor: pointer; }
        .tab-btn.active { background: var(--neon-green); color: #000; border-color: var(--neon-green); }

        main { display: flex; flex: 1; overflow: hidden; flex-direction: column; }

        /* ROSTER SECTION (Persistent & Resizeable) */
        #roster-section { 
            display: flex; flex-direction: column; background: var(--panel-bg); 
            flex-shrink: 0; height: 40dvh; border-bottom: 1px solid var(--border);
            min-height: 50px;
        }
        .roster-header { padding: 10px 15px; background: #000; font-size: 14px; font-weight: bold; color: var(--neon-green); flex-shrink: 0; }
        #rosterBody { flex: 1; overflow-y: auto; padding: 10px; }
        .player-row { display: flex; align-items: center; gap: 10px; padding: 10px; background: #282828; border-radius: 8px; margin-bottom: 6px; border: 1px solid #333; }
        .player-row input { background: #000; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 6px; font-size: 16px; }
        .controls { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #000; flex-shrink: 0; }

        /* DRAG HANDLE */
        #drag-handle {
            height: 30px; background: #222; cursor: ns-resize;
            display: flex; align-items: center; justify-content: center;
            border-top: 1px solid #333; border-bottom: 1px solid #333; flex-shrink: 0;
            touch-action: none;
        }

        /* TOOL CONTENT */
        #tool-content { flex: 1; overflow-y: auto; padding: 15px; background: var(--bg-dark); }
        .tool-panel { display: none; }
        .tool-panel.active { display: block !important; }

        /* LANDSCAPE / DESKTOP */
        @media (min-width: 800px), (orientation: landscape) {
            main { flex-direction: row; }
            #roster-section { width: 350px; height: 100% !important; border-right: 2px solid var(--border); border-bottom: none; }
            #drag-handle { display: none !important; }
        }

        /* STICKY TABLE */
        .sticky-controls { position: sticky; top: -15px; background: var(--bg-dark); z-index: 10; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .table-wrapper { width: 100%; overflow-x: auto; border-radius: 8px; }
        .assignment-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .assignment-table th { background: var(--neon-green); color: #000; padding: 12px; }
        .assignment-table td { padding: 12px; border-bottom: 1px solid var(--border); text-align: center; background: #1a1a1a; font-size: 14px; }

        /* BUTTONS */
        button { border: none; border-radius: 6px; padding: 10px; cursor: pointer; font-weight: bold; color: white; background: #444; }
        .btn-main { background: var(--neon-green); color: #000; width: 100%; padding: 15px; border-radius: 10px; margin-top: 10px; }
        .btn-del { background: var(--danger); font-size: 12px; padding: 8px; }
        .job-pool-config { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; background: #000; padding: 12px; border-radius: 12px; margin-bottom: 10px; }

        /* CAPTAIN FLAIR */
        .captain-card { background: #000; border: 2px solid var(--neon-green); padding: 25px 10px; text-align: center; border-radius: 12px; font-weight: bold; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .pool-chips-container { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; }
        .pool-chip { background: #222; border: 1px solid #444; padding: 5px 12px; border-radius: 20px; font-size: 11px; white-space: nowrap; }
        @keyframes flare {
            0% { box-shadow: 0 0 0 var(--neon-green); transform: scale(1); }
            50% { box-shadow: 0 0 25px var(--neon-green); transform: scale(1.05); background: var(--neon-green); color: #000; }
            100% { box-shadow: 0 0 5px var(--neon-green); transform: scale(1); }
        }
        .flare-active { animation: flare 0.6s ease-out; }
    </style>
</head>
<body>

<nav>
    <button class="tab-btn active" onclick="showTool('work-tool', this)">Assignments</button>
    <button class="tab-btn" onclick="showTool('captain-tool', this)">Captains</button>
</nav>

<main>
    <section id="roster-section">
        <div class="roster-header">Team Roster</div>
        <div id="rosterBody"></div>
        <div class="controls">
            <button onclick="addPlayer()">+ Add</button>
            <button onclick="sortRoster()">Sort #</button>
            <button class="tab-btn active" style="grid-column: span 2; background: var(--neon-green); color: #000;" onclick="saveRoster()">SAVE ROSTER</button>
        </div>
    </section>

    <div id="drag-handle"><div style="width: 40px; height: 4px; background: #555; border-radius: 2px;"></div></div>

    <section id="tool-content">
        <div id="work-tool" class="tool-panel active">
            <div class="sticky-controls">
                <button class="btn-del" onclick="resetShiftCounter()" style="width: 100%; height: 50px; margin-bottom: 10px;">
                    RESET REFFED COUNT: <span id="counterVal">0</span>
                </button>
                <div class="job-pool-config">
                    <label><input type="checkbox" class="job-check" value="Lines 1" checked> Lines 1</label>
                    <label><input type="checkbox" class="job-check" value="Book" checked> Book</label>
                    <label><input type="checkbox" class="job-check" value="Score" checked> Score</label>
                    <label><input type="checkbox" class="job-check" value="Lines 2" checked> Lines 2</label>
                    <label><input type="checkbox" class="job-check" value="Down Ref" checked> Down Ref</label>
                    <label><input type="checkbox" class="job-check" value="Libero" checked> Libero</label>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="sets" value="3" style="width: 70px; background: #000; color: #fff; border: 1px solid #444;">
                    <button class="btn-main" style="margin: 0;" onclick="generate()">GENERATE ASSIGNMENTS</button>
                </div>
            </div>
            <div class="table-wrapper"><div id="assignTable"></div></div>
        </div>

        <div id="captain-tool" class="tool-panel">
            <button class="btn-main" onclick="pickPair()">[ PICK NEW PAIR ]</button>
            <div style="display: flex; gap: 10px; margin: 20px 0;">
                <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                    <div id="cap1" class="captain-card">?</div>
                    <button onclick="reroll(1)">Reroll 1</button>
                </div>
                <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                    <div id="cap2" class="captain-card">?</div>
                    <button onclick="reroll(2)">Reroll 2</button>
                </div>
            </div>
            <div style="background:#000; padding:15px; border-radius:12px;">
                <div style="font-size:12px; color:#888; margin-bottom:5px;">REMAINING POOL (<span id="poolCount">0</span>)</div>
                <div id="poolList" class="pool-chips-container"></div>
            </div>
        </div>
    </section>
</main>

<script>
    let roster = JSON.parse(localStorage.getItem('vb-roster')) || [];
    let globalPointer = parseInt(localStorage.getItem('vb-pointer')) || 0;
    let shiftCounter = parseInt(localStorage.getItem('vb-shift-counter')) || 0;
    let captainPool = JSON.parse(localStorage.getItem('vb-captain-pool')) || [];
    let currentCaptains = [null, null];

    // --- SWIPE LOGIC FIX ---
    const handle = document.getElementById('drag-handle');
    const rosterSection = document.getElementById('roster-section');
    let isDragging = false;

    handle.addEventListener('touchstart', (e) => { isDragging = true; }, { passive: true });
    window.addEventListener('touchend', () => isDragging = false);
    window.addEventListener('touchmove', (e) => {
        if (!isDragging || window.innerWidth > window.innerHeight) return;
        if (e.cancelable) e.preventDefault();
        const touchY = e.touches.clientY;
        const navHeight = document.querySelector('nav').offsetHeight;
        const newHeight = ((touchY - navHeight) / window.innerHeight) * 100;
        if (newHeight > 5 && newHeight < 80) rosterSection.style.height = `${newHeight}dvh`;
    }, { passive: false });

    // --- TOOL SWITCHING ---
    function showTool(id, btn) {
        document.querySelectorAll('.tool-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    // --- ROSTER LOGIC ---
    function render() {
        const body = document.getElementById('rosterBody');
        body.innerHTML = '';
        roster.forEach((p, i) => {
            body.innerHTML += `<div class="player-row">
                <input type="checkbox" ${p.active ? 'checked' : ''} onchange="togglePlayer(${i})">
                <input type="text" value="${p.name}" onchange="updateName(${i}, this.value)">
                <input type="number" value="${p.number}" onchange="updateNum(${i}, this.value)" style="width:50px">
                <button class="btn-del" onclick="removePlayer(${i})">Ã—</button>
            </div>`;
        });
        updatePoolUI();
        document.getElementById('counterVal').innerText = shiftCounter;
    }

    function togglePlayer(i) { roster[i].active = !roster[i].active; }
    function updateName(i, v) { roster[i].name = v; }
    function updateNum(i, v) { roster[i].number = v; }
    function addPlayer() { roster.push({name:"", number:"", active:true}); render(); }
    function removePlayer(i) { roster.splice(i, 1); render(); }
    function sortRoster() { roster.sort((a,b) => parseInt(a.number) - parseInt(b.number)); render(); }
    function saveRoster() { localStorage.setItem('vb-roster', JSON.stringify(roster)); alert("Roster Saved!"); }
    
    function saveState() {
        localStorage.setItem('vb-pointer', globalPointer);
        localStorage.setItem('vb-shift-counter', shiftCounter);
        document.getElementById('counterVal').innerText = shiftCounter;
    }

    function resetShiftCounter() { if(confirm("Reset all rotations?")) { shiftCounter=0; globalPointer=0; saveState(); render(); } }

    // --- ASSIGNMENT GENERATION (13-Player Prime Logic) ---
    function generate() {
        const active = roster.filter(p => p.active);
        const jobs = Array.from(document.querySelectorAll('.job-check:checked')).map(c => c.value);
        const numSets = parseInt(document.getElementById('sets').value);
        if (!active.length || !jobs.length) return;

        let html = `<table class="assignment-table"><thead><tr><th>Set</th>`;
        jobs.forEach(j => html += `<th>${j}</th>`);
        html += `</tr></thead><tbody>`;

        let tempPointer = globalPointer;
        for (let s = 0; s < numSets; s++) {
            html += `<tr><td>Set ${s + 1}</td>`;
            let offset = (shiftCounter * 11 + s) % jobs.length;
            let row = new Array(jobs.length);
            for (let j = 0; j < jobs.length; j++) {
                let pIdx = (tempPointer + j) % active.length;
                row[(j + offset) % jobs.length] = `${active[pIdx].name} (#${active[pIdx].number})`;
            }
            row.forEach(cell => html += `<td>${cell}</td>`);
            html += `</tr>`;
            for(let i=0; i<jobs.length; i++) {
                tempPointer++;
                if(tempPointer >= active.length) { tempPointer = 0; shiftCounter++; }
            }
        }
        globalPointer = tempPointer; saveState();
        document.getElementById('assignTable').innerHTML = html + `</tbody></table>`;
    }

    // --- CAPTAIN LOGIC ---
    function updatePoolUI() {
        document.getElementById('poolCount').innerText = captainPool.length;
        const list = document.getElementById('poolList');
        list.innerHTML = '';
        captainPool.forEach(p => list.innerHTML += `<div class="pool-chip">#${p.number} ${p.name}</div>`);
        [1, 2].forEach(i => {
            const c = currentCaptains[i-1];
            document.getElementById(`cap${i}`).innerText = c ? `${c.name} (#${c.number})` : "?";
        });
    }

    function pickPair() { currentCaptains = [null, null]; reroll(1); reroll(2); }

    function reroll(idx) {
        const active = roster.filter(p => p.active);
        if (active.length < 2) return;
        if (captainPool.length === 0) {
            const curIds = currentCaptains.filter(c => c).map(c => c.number);
            captainPool = active.filter(p => !curIds.includes(p.number)).map(p => ({...p}));
        }
        const r = Math.floor(Math.random() * captainPool.length);
        currentCaptains[idx - 1] = captainPool.splice(r, 1)[0];
        localStorage.setItem('vb-captain-pool', JSON.stringify(captainPool));
        const el = document.getElementById(`cap${idx}`);
        el.classList.remove('flare-active'); void el.offsetWidth; el.classList.add('flare-active');
        updatePoolUI();
    }

    render();
</script>
</body>
</html>
